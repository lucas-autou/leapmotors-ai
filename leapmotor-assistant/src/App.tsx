import { useState, useEffect } from 'react';
import { Avatar, type AvatarEmotion } from './components/Avatar';
import { ChatInterface } from './components/ChatInterface';
import { VehicleCards } from './components/VehicleCards';
import { ServiceOptions } from './components/ServiceOptions';
import { AIInsights } from './components/AIInsights';
import { openAIService, type Intent } from './services/openai';
import { openaiSpeechService } from './services/openaiSpeech';
import type { Message, Vehicle } from './types';

function App() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [audioEnabled, setAudioEnabled] = useState(true);
  const [avatarEmotion, setAvatarEmotion] = useState<AvatarEmotion>('welcoming');
  const [currentIntent, setCurrentIntent] = useState<Intent>('general_conversation');
  const [isThinking, setIsThinking] = useState(false);
  const [hasInitialized, setHasInitialized] = useState(false);
  const [isIntroSpeech, setIsIntroSpeech] = useState(true); // Flag para saber se √© a fala de intro

  useEffect(() => {
    // Evita execu√ß√£o dupla
    if (hasInitialized) return;
    
    // Initialize services - agora s√≥ precisamos da chave OpenAI!
    const apiKey = import.meta.env.VITE_OPENAI_API_KEY || 'demo';
    
    console.log('üöÄ Inicializando LEAP AI v2.0 com OpenAI...');
    openAIService.initialize(apiKey);
    openaiSpeechService.initialize(apiKey);
    
    // Send welcome message
    const welcomeMessage: Message = {
      id: Date.now().toString(),
      role: 'assistant',
      content: 'Ol√°! Bem-vindo √† Leapmotor! Eu sou a Lea, sua assistente virtual. Como posso ajud√°-lo hoje?',
      timestamp: new Date()
    };
    setMessages([welcomeMessage]);
    setAvatarEmotion('welcoming');
    
    // Marca como inicializado ANTES de falar para evitar duplica√ß√£o
    setHasInitialized(true);
    
    // Fala automaticamente a mensagem de boas-vindas ao abrir (intro)
    setTimeout(() => {
      speakMessage(welcomeMessage.content, 'welcoming', true); // true = √© intro
    }, 1000); // Delay maior para garantir que OpenAI TTS est√° completamente inicializado
  }, [hasInitialized]); // Adiciona hasInitialized como depend√™ncia

  const speakMessage = (text: string, emotion: AvatarEmotion = 'happy', isIntro: boolean = false) => {
    // Come√ßa a mostrar v√≠deo imediatamente
    setIsSpeaking(true);
    setAvatarEmotion(emotion);
    setIsIntroSpeech(isIntro); // Define se √© fala de intro

    // Mapear emo√ß√£o do avatar para op√ß√µes de voz OpenAI
    const emotionMap: Record<AvatarEmotion, 'neutral' | 'happy' | 'excited' | 'concerned' | 'cheerful' | 'friendly'> = {
      'neutral': 'neutral',
      'happy': 'happy',
      'thinking': 'neutral',
      'excited': 'excited',
      'curious': 'friendly',
      'concerned': 'concerned',
      'welcoming': 'cheerful',
      'professional': 'neutral',
      'confident': 'friendly',
      'empathetic': 'cheerful',
      'processing': 'neutral',
      'surprised': 'excited',
      'satisfied': 'happy'
    };

    console.log(`üéôÔ∏è Falando com emo√ß√£o: ${emotion} -> ${emotionMap[emotion]}`);

    openaiSpeechService.speak(text, {
      emotion: emotionMap[emotion],
      speed: 1.0, // Velocidade normal para naturalidade
      voice: 'shimmer' // Voz feminina suave e fluida
    }, () => {
      // Delay maior para garantir que o v√≠deo continue at√© o fim do √°udio
      setTimeout(() => {
        setIsSpeaking(false);
        setAvatarEmotion('neutral');
        setIsIntroSpeech(false); // Sempre volta para modo conversa√ß√£o ap√≥s qualquer fala
        console.log('üîá Fala conclu√≠da - transi√ß√£o suave para imagem');
      }, 500); // Delay maior para sincronizar com fim real do √°udio
    });
  };

  const handleSendMessage = async (content: string) => {
    // Add user message
    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content,
      timestamp: new Date()
    };
    setMessages(prev => [...prev, userMessage]);

    // Set thinking state
    setIsThinking(true);
    setAvatarEmotion('processing');

    // Get AI response with enhanced context
    const conversationHistory = messages.map(m => ({
      role: m.role,
      content: m.content
    }));

    try {
      const aiResponse = await openAIService.getResponse(content, conversationHistory);

      // Update states based on AI response
      setCurrentIntent(aiResponse.intent);
      setIsThinking(false);

      // Map intent to emotion - usando novos estados emocionais
      const intentToEmotion: Record<Intent, AvatarEmotion> = {
        'greeting': 'welcoming',
        'vehicle_inquiry': 'curious',
        'test_drive_request': 'excited',
        'coffee_request': 'satisfied',
        'consultant_request': 'professional',
        'appointment_request': 'confident',
        'financing_inquiry': 'concerned',
        'sustainability_question': 'empathetic',
        'general_conversation': 'neutral',
        'goodbye': 'satisfied'
      };

      const responseEmotion = intentToEmotion[aiResponse.intent] || 'neutral';
      setAvatarEmotion(responseEmotion);

      // Add assistant response
      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: aiResponse.response,
        timestamp: new Date()
      };
      setMessages(prev => [...prev, assistantMessage]);

      // Speak response with appropriate emotion
      if (audioEnabled) {
        speakMessage(aiResponse.response, responseEmotion);
      } else {
        // Se n√£o for falar, mant√©m emo√ß√£o por um tempo
        setTimeout(() => setAvatarEmotion('neutral'), 3000);
      }
    } catch (error) {
      console.error('Erro ao processar mensagem:', error);
      setIsThinking(false);
      setAvatarEmotion('concerned');

      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: 'Desculpe, tive um problema para processar sua mensagem. Pode tentar novamente? üòÖ',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);

      if (audioEnabled) {
        speakMessage(errorMessage.content, 'concerned');
      }
    }
  };

  const handleToggleListening = () => {
    if (isListening) {
      openaiSpeechService.stopListening();
      setIsListening(false);
      setAvatarEmotion('neutral');
      console.log('üé§ Parou de escutar');
    } else {
      setIsListening(true);
      setAvatarEmotion('curious'); // Mostra que est√° prestando aten√ß√£o
      console.log('üé§ Come√ßou a escutar...');

      openaiSpeechService.startListening(
        (transcript, confidence) => {
          setIsListening(false);
          console.log(`‚úÖ Reconhecido (${Math.round(confidence * 100)}%): "${transcript}"`);

          // Processar com confian√ßa mais baixa pois OpenAI/Web Speech s√£o bons
          if (confidence > 0.2) {
            handleSendMessage(transcript);
          } else {
            setAvatarEmotion('concerned');
            console.log('‚ùå Confian√ßa muito baixa, ignorando transcri√ß√£o');

            const errorMessage: Message = {
              id: Date.now().toString(),
              role: 'assistant',
              content: `Desculpe, n√£o consegui entender muito bem. Pode repetir? üé§`,
              timestamp: new Date()
            };
            setMessages(prev => [...prev, errorMessage]);

            setTimeout(() => setAvatarEmotion('neutral'), 2000);
          }
        },
        (error) => {
          console.error('‚ùå Erro reconhecimento de voz:', error);
          setIsListening(false);
          setAvatarEmotion('concerned');

          // Mostrar erro de forma mais amig√°vel
          const errorMessage: Message = {
            id: Date.now().toString(),
            role: 'assistant',
            content: `Ops! ${error} üé§ Pode tentar novamente ou digitar sua mensagem.`,
            timestamp: new Date()
          };
          setMessages(prev => [...prev, errorMessage]);

          setTimeout(() => setAvatarEmotion('neutral'), 3000);
        },
        () => {
          setIsListening(false);
          setAvatarEmotion('neutral');
          console.log('üé§ Reconhecimento finalizado');
        }
      );
    }
  };

  const handleToggleSpeaking = () => {
    if (audioEnabled) {
      openaiSpeechService.stopSpeaking();
      setAudioEnabled(false);
      setIsSpeaking(false);
      setAvatarEmotion('neutral');
      console.log('üîá √Åudio desativado');
    } else {
      setAudioEnabled(true);
      setAvatarEmotion('happy');
      console.log('üîä √Åudio ativado - usando OpenAI TTS');

      // Breve confirma√ß√£o de que o √°udio foi ativado
      setTimeout(() => setAvatarEmotion('neutral'), 1500);
    }
  };

  const handleSelectVehicle = (vehicle: Vehicle) => {
    const message = `Estou interessado no ${vehicle.name}. Pode me contar mais sobre ele?`;
    handleSendMessage(message);
  };

  const handleSelectService = (service: string) => {
    let message = '';
    switch (service) {
      case 'coffee':
        message = 'Gostaria de tomar um caf√© enquanto conhecemos os ve√≠culos.';
        break;
      case 'test-drive':
        message = 'Quero agendar um test-drive!';
        break;
      case 'consultant':
        message = 'Gostaria de falar com um consultor especializado.';
        break;
      case 'schedule':
        message = 'Quero agendar uma visita.';
        break;
      case 'coffee-espresso':
        message = 'Vou querer um caf√© expresso, por favor.';
        break;
      case 'coffee-double-espresso':
        message = 'Um expresso duplo seria perfeito!';
        break;
      case 'coffee-latte':
        message = 'Gostaria de um caf√© com leite.';
        break;
      case 'coffee-cappuccino':
        message = 'Um cappuccino, por favor.';
        break;
      case 'eco-info':
        message = 'Quais s√£o os benef√≠cios ecol√≥gicos dos ve√≠culos Leapmotor?';
        break;
      case 'financing':
        message = 'Quais s√£o as op√ß√µes de financiamento dispon√≠veis?';
        break;
      case 'warranty':
        message = 'Como funciona a garantia e o suporte dos ve√≠culos?';
        break;
      default:
        message = `Estou interessado em ${service}`;
    }
    handleSendMessage(message);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-leap-dark via-leap-surface to-leap-dark">
      {/* Header Premium Compacto */}
      <header className="bg-leap-surface/80 backdrop-blur-xl border-b border-leap-border">
        <div className="container mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="relative">
                <div className="w-12 h-12 bg-gradient-to-br from-leap-green-primary to-leap-green-neon rounded-xl flex items-center justify-center shadow-lg animate-glow">
                  <span className="text-white font-bold text-xl">L</span>
                </div>
                <div className="absolute -top-1 -right-1 w-3 h-3 bg-leap-green-neon rounded-full animate-pulse"></div>
              </div>
              <div>
                <h1 className="text-xl font-bold text-leap-text-primary">Leapmotor Brasil</h1>
                <p className="text-leap-green-primary text-sm font-medium">LEAP AI 4.0 ‚Ä¢ Experi√™ncia Imersiva</p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              <div className="text-right">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-leap-green-neon rounded-full animate-pulse"></div>
                  <span className="text-leap-green-primary font-medium text-sm">IA Neural Ativa</span>
                </div>
              </div>
              
              <div className="px-3 py-1 bg-leap-green-soft border border-leap-green-primary/30 rounded-full backdrop-blur-sm">
                <span className="text-leap-green-primary text-sm font-medium">ü§ñ Online</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content - Layout Imersivo */}
      <main className="container mx-auto px-6 py-4">
        {/* Layout Imersivo com LEA como protagonista */}
        <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
          
          {/* LEA AVATAR - Protagonista da experi√™ncia */}
          <div className="xl:col-span-1">
            <div className="bg-leap-surface/60 backdrop-blur-xl rounded-2xl border border-leap-border p-6 relative overflow-hidden animate-fade-in">
              {/* Efeito de fundo premium */}
              <div className="absolute inset-0 bg-gradient-to-br from-leap-green-primary/5 via-transparent to-leap-green-neon/5"></div>
              {/* Neural network background */}
              <div className="absolute inset-0 opacity-10">
                <svg width="100%" height="100%" viewBox="0 0 400 300">
                  <defs>
                    <radialGradient id="nodeGradient" cx="50%" cy="50%">
                      <stop offset="0%" stopColor="#00B74F" />
                      <stop offset="100%" stopColor="transparent" />
                    </radialGradient>
                  </defs>
                  {[...Array(12)].map((_, i) => (
                    <circle
                      key={i}
                      cx={50 + (i % 4) * 100}
                      cy={50 + Math.floor(i / 4) * 100}
                      r="3"
                      fill="url(#nodeGradient)"
                    />
                  ))}
                  {/* Connection lines */}
                  <path d="M 50 50 L 150 50 L 250 150 M 150 150 L 350 50"
                        stroke="#00B74F" strokeWidth="1" opacity="0.3" />
                </svg>
              </div>

              {/* LEA Avatar - Protagonista Imersiva */}
              <div className="relative z-10">
                <Avatar
                  isSpeaking={isSpeaking}
                  emotion={avatarEmotion}
                  isListening={isListening}
                  isIdle={!isSpeaking && !isListening && !isThinking}
                  size="hero"
                  isIntro={isIntroSpeech}
                />

                {/* LEA Status Premium */}
                <div className="mt-4 text-center space-y-3">
                  <div>
                    <h2 className="text-2xl font-bold text-leap-text-primary mb-1">LEA</h2>
                    <p className="text-leap-green-primary text-sm font-medium">
                      Consultora Digital Avan√ßada
                    </p>
                  </div>

                  {/* Status din√¢mico premium */}
                  <div className="bg-leap-surface/80 backdrop-blur-sm rounded-xl px-4 py-2 border border-leap-border">
                    <p className="text-sm text-leap-text-secondary">
                      {isThinking ? 'üß† Pensando...' :
                       isSpeaking ? 'üí¨ Conversando' :
                       isListening ? 'üëÇ Escutando' :
                       '‚ú® Pronta para ajudar'}
                    </p>
                  </div>

                  {/* Mini indicadores */}
                  <div className="flex justify-center items-center gap-3 text-xs">
                    <div className="flex items-center gap-1">
                      <div className={`w-2 h-2 rounded-full ${
                        isThinking ? 'bg-purple-400 animate-pulse' :
                        isSpeaking ? 'bg-leap-green-neon animate-pulse' :
                        isListening ? 'bg-cyan-400 animate-pulse' :
                        'bg-leap-border'
                      }`} />
                      <span className="text-leap-text-muted capitalize">
                        {currentIntent.replace('_', ' ')}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* CHAT INTERFACE - Expandida e Premium */}
          <div className="xl:col-span-2 space-y-6">
            {/* Chat Interface Premium */}
            <div className="h-[600px] bg-leap-surface/60 backdrop-blur-xl rounded-2xl border border-leap-border animate-fade-in">
              <ChatInterface
                messages={messages}
                onSendMessage={handleSendMessage}
                isListening={isListening}
                onToggleListening={handleToggleListening}
                isSpeaking={audioEnabled}
                onToggleSpeaking={handleToggleSpeaking}
              />
            </div>

            {/* Painel de Servi√ßos Premium */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <ServiceOptions onSelectService={handleSelectService} />
              <VehicleCards onSelectVehicle={handleSelectVehicle} />
            </div>

            {/* AI Insights Melhorado */}
            <AIInsights
              currentIntent={currentIntent}
              emotion={avatarEmotion}
              isThinking={isThinking}
              isSpeaking={isSpeaking}
              isListening={isListening}
              messagesCount={messages.length}
            />
          </div>
        </div>
      </main>

      {/* Footer Premium */}
      <footer className="bg-leap-surface/80 backdrop-blur-xl border-t border-leap-border mt-8">
        <div className="container mx-auto px-6 py-6">
          <div className="text-center">
            <p className="text-sm text-leap-text-secondary">
              ¬© 2024 Leapmotor Brasil - LEAP AI 4.0 Experi√™ncia Imersiva
            </p>
            <p className="text-xs text-leap-text-muted mt-1">
              Powered by Advanced Neural Networks
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
}

export default App;
